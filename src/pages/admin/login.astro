---
import { Button } from "@/src/core/components/button";
import Header from "@/src/core/components/Header.astro";
import Layout from "@/src/core/Layout.astro";
import { createAdminClient, SESSION_COOKIE } from "@/src/lib/appwrite";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const data = {
    email: formData.get("email"),
    password: formData.get("password"),
  };
  const { email, password } = data;

  const { account } = createAdminClient();

  const session = await account.createEmailPasswordSession(
    `${email}`,
    `${password}`
  );

  Astro.cookies.set(SESSION_COOKIE, session.secret, {
    path: "/",
    expires: new Date(session.expire),
    sameSite: "strict",
    secure: true,
    httpOnly: true,
  });

  return Astro.redirect("/admin");
}
---

<Layout>
  <div class="flex flex-col h-full">
    <Header />
    <div class="flex flex-1 items-center justify-center">
      <form
        method="POST"
        class="max-w-sm mx-auto p-4 bg-white shadow-md rounded flex-1 font-light"
      >
        <div class="mb-4">
          <h2 class="text-3xl text-center font-bold pb-2">Iniciar Sesión</h2>
          <label class="block text-gray-700 text-sm font-bold mb-2" for="email">
            Correo
          </label>
          <input
            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
            name="email"
            type="email"
            placeholder="example12@fakemail.com"
          />
        </div>
        <div class="mb-6">
          <label
            class="block text-gray-700 text-sm font-bold mb-2"
            for="password"
          >
            Contraseña
          </label>
          <input
            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
            name="password"
            type="password"
            placeholder="******************"
          />
        </div>
        <div class="flex items-center justify-between">
          <Button>Ingresar</Button>
        </div>
      </form>
    </div>
    <span class="w-full text-center p-2"
      >CMS powered by <a
        href="https://choya.tech"
        target="_blank"
        class="font-bold bg-gradient-to-tr from-green-400 to-emerald-800 bg-clip-text text-transparent"
        >Choya.Tech</a
      ></span
    >
  </div>
</Layout>
